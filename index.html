<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>1Xbet Manager</title>
  <style>
    body { font-family: sans-serif; margin:0; padding-top:12rem; background:#f2f2f2; }
    body.dark-mode { background:#222; color:#ddd; }
    body.dark-mode .customer, body.dark-mode .modal-content, body.dark-mode .fixed-top { background:#333; color:#fff; }
    .fixed-top { position:fixed; top:0;left:0;right:0; background:#f2f2f2; padding:1rem; box-shadow:0 2px 5px rgba(0,0,0,.1); z-index:100; }
    h1 { text-align:center; font-size:1.2rem; margin:0 0 .5rem; color:#003366; }
    .top-summary { display:flex; flex-wrap:wrap; justify-content:center; gap:1rem; margin-bottom:.5rem; font-size:.9rem; font-weight:bold; }
    .top-bar { display:flex; flex-direction:column; gap:.5rem; }
    @media(min-width:600px){ .top-bar { flex-direction:row; justify-content:center; flex-wrap:wrap; } }
    .top-bar input { padding:.5rem; border-radius:5px; border:1px solid #ccc; flex:1; }
    button { padding:.5rem 1rem; border:none; border-radius:5px; cursor:pointer; background:#003366; color:#fff; }
    button.small { font-size:.75rem; padding:.25rem .5rem; margin-left:.5rem; }
    .customer { background:#fff; border-radius:8px; padding:1rem; margin-bottom:1rem; box-shadow:0 2px 5px rgba(0,0,0,.1); }
    .customer-header { display:flex; flex-direction:column; gap:.5rem; }
    .action-row-top { display:flex; gap:.5rem; margin-top:.5rem; flex-wrap:wrap; align-items:center; }
    .action-row-bottom { display:flex; flex-direction:column; gap:.5rem; margin-top:.5rem; align-items:center; }
    .action-row-bottom button { width:100%; max-width:500px; }
    .history { display:none; margin-top:.5rem; background:#f9f9f9; padding:.5rem; border-radius:5px; max-height:150px; overflow-y:auto; font-size:.9rem; }
    input.amount-input { width:100px; padding:.25rem; border:1px solid #ccc; border-radius:4px; }
    .modal { display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,.5); justify-content:center;align-items:center; z-index:200; }
    .modal-content { background:#fff; padding:2rem 1rem 1rem; border-radius:8px; width:90%; max-width:400px; position:relative; display:flex;flex-direction:column; box-sizing:border-box; overflow:hidden; }
    .modal-content input { width:100%; padding:.5rem; margin-bottom:1rem; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; }
    .modal-content button { width:100%; }
    .modal-close { position:absolute; top:.5rem; right:.75rem; font-size:1.5rem; font-weight:bold; cursor:pointer; color:#888; z-index:1; }
    #editSelectList { display:none; background:#fff; padding:1rem; border-radius:8px; max-height:300px; overflow-y:auto; margin-bottom:1rem; box-shadow:0 2px 5px rgba(0,0,0,.1); }
    #editSelectList div { padding:.5rem; border-bottom:1px solid #eee; cursor:pointer; }
    #editSelectList div:hover { background:#f0f0f0; }
    #lockOverlay { position:fixed; top:0;left:0;right:0;bottom:0; background:#fff; display:flex; align-items:center; justify-content:center; flex-direction:column; z-index:500; }
    #sideMenu { position:fixed; top:0; bottom:0; left:-250px; width:250px; background:#003366; color:#fff; padding:1rem; transition:left .3s; z-index:400; }
    #sideMenu button { background:none; border:none; color:#fff; display:block; margin:.5rem 0; text-align:left; }
  </style>
</head>
<body>
  <div id="lockOverlay">
    <p id="lockMsg">Veuillez vous authentifier</p>
    <button id="fpBtn">🔒 Empreinte digitale</button>
    <input type="password" id="lockPwd" placeholder="Mot de passe" style="display:none;margin-top:1rem;">
    <button id="pwdBtn" style="display:none;">Déverrouiller</button>
  </div>

  <div id="sideMenu">
    <button onclick="closeMenu()">×</button>
    <button onclick="registerFingerprint()">Enregistrer empreinte</button>
    <button onclick="openSetPwd()">Définir mot de passe</button>
    <button onclick="toggleDarkMode()">Mode sombre</button>
    <button onclick="alert('Calculatrice à venir')">Calculatrice</button>
  </div>

  <div class="fixed-top">
    <h1>1Xbet</h1>
    <div class="top-summary" id="totalSummary"></div>
    <div class="top-bar">
      <button onclick="openCustomerModal('add')">Ajouter un client</button>
      <button onclick="showEditList()">Modifier un client</button>
      <input type="text" id="search" placeholder="Rechercher..." oninput="renderCustomers()">
    </div>
  </div>

  <div id="editSelectList"></div>
  <div id="customerList"></div>

  <div class="modal" id="customerModal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <input type="text" id="modalName" placeholder="Nom du client">
      <input type="text" id="modalId" placeholder="ID du client">
      <button onclick="submitCustomer()">Enregistrer</button>
    </div>
  </div>

  <script>
    // 🛡️ Auth
    let credId = localStorage.getItem('credentialId'), storedPassword = localStorage.getItem('appPassword') || '', failCount=0;
    document.getElementById('fpBtn').onclick = authenticateFingerprint;
    document.getElementById('pwdBtn').onclick =()=> {
      if(document.getElementById('lockPwd').value===storedPassword) unlockApp();
      else alert('Mot de passe incorrect');
    };
    async function authenticateFingerprint(){
      if(!window.PublicKeyCredential) return alert("WebAuthn non disponible");
      if(!credId) return alert("Enregistrez d'abord une empreinte via le menu");
      try{
        await navigator.credentials.get({ publicKey:{
          challenge:new Uint8Array(32),
          allowCredentials:[{ id:Uint8Array.from(atob(credId),c=>c.charCodeAt(0)), type:"public-key" }],
          timeout:60000, userVerification:"required"
        }});
        unlockApp();
      }catch(e){ failCount++; if(failCount>=3){ document.getElementById('lockPwd').style.display=''; document.getElementById('pwdBtn').style.display=''; } else alert(`Échec. ${3-failCount} essais restants`); }
    }
    function unlockApp(){ document.getElementById('lockOverlay').style.display='none'; }

    async function registerFingerprint(){
      if(!window.PublicKeyCredential) return alert("WebAuthn non supporté");
      try {
        const publicKey={
          challenge:new Uint8Array(26),
          rp:{ name:"1Xbet WebApp" },
          user:{ id:new Uint8Array(16), name:"user@example.com", displayName:"Utilisateur" },
          pubKeyCredParams:[{ alg:-7, type:"public-key" }],
          authenticatorSelection:{ authenticatorAttachment:"platform", userVerification:"required" },
          timeout:60000, attestation:"direct"
        };
        const cred=await navigator.credentials.create({ publicKey });
        const rawId=btoa(String.fromCharCode(...new Uint8Array(cred.rawId)));
        localStorage.setItem('credentialId',rawId);
        credId=rawId;
        alert("Empreinte enregistrée !");
      } catch(err){
        alert("Erreur: "+err.message);
      }
    }

    function openSetPwd(){
      const pwd=prompt("Définir un mot de passe:");
      if(pwd){ localStorage.setItem('appPassword',pwd); storedPassword=pwd; alert("Mot de passe enregistré"); }
    }

    function toggleDarkMode(){ document.body.classList.toggle('dark-mode'); }
    function closeMenu(){ document.getElementById('sideMenu').style.left='-250px'; }

    // 👥 Clients
    let customers=JSON.parse(localStorage.getItem('customers')||'[]'), modalMode='add', editingCustomer=null;

    function saveCustomers(){ localStorage.setItem('customers',JSON.stringify(customers)); }
    function openCustomerModal(mode){
      modalMode=mode; document.getElementById('modalName').value=''; document.getElementById('modalId').value=''; editingCustomer=null;
      document.getElementById('customerModal').style.display='flex';
    }
    function closeModal(){ document.getElementById('customerModal').style.display='none'; }

    function submitCustomer(){
      const name=document.getElementById('modalName').value.trim(), id=document.getElementById('modalId').value.trim();
      if(!name||!id) return alert("Champs requis");
      if(modalMode==='add') customers.push({ name,id,history:[],total:0 });
      else if(editingCustomer) { editingCustomer.name=name; editingCustomer.id=id; }
      closeModal(); saveCustomers(); renderCustomers();
    }

    function showEditList(){
      const list=document.getElementById('editSelectList');
      list.innerHTML='<button onclick="cancelEditList()">Annuler</button>';
      customers.forEach((c,i)=>{
        const item=document.createElement('div');
        item.textContent=`${c.name} (${c.id})`;
        item.onclick=()=>{
          editingCustomer=customers[i];
          document.getElementById('modalName').value=c.name;
          document.getElementById('modalId').value=c.id;
          modalMode='edit';
          document.getElementById('customerModal').style.display='flex';
          list.style.display='none';
        };
        list.appendChild(item);
      });
      list.style.display='block';
    }

    function cancelEditList(){ document.getElementById('editSelectList').style.display='none'; }
    function deleteCustomer(i){ if(confirm("Supprimer ce client?")) { customers.splice(i,1); saveCustomers(); renderCustomers(); } }
    function copyId(id){ navigator.clipboard.writeText(id).then(()=>alert("ID copié")); }
    function addTransaction(i,type){
      const input=document.getElementById(`amount-${i}`), amount=input.value.trim();
      if(!amount||isNaN(amount)) return alert("Montant invalide");
      const value= type==='add'? +amount : -amount;
      const entry={ value,date:new Date().toLocaleString() };
      customers[i].history.push(entry);
      customers[i].total=(customers[i].total||0)+value;
      input.value=''; saveCustomers(); renderCustomers();
    }

    function toggleHistory(i){ const el=document.getElementById(`history-${i}`); el.style.display= el.style.display==='block'? 'none':'block'; }

    function renderCustomers(){
      const search=document.getElementById('search').value.toLowerCase();
      const list=document.getElementById('customerList'), totalSummary=document.getElementById('totalSummary');
      list.innerHTML=''; totalSummary.innerHTML=''; let total=0;
      customers.forEach((c,i)=>{
        if(!c.name.toLowerCase().includes(search) && !c.id.toLowerCase().includes(search)) return;
        const div=document.createElement('div'); div.className='customer';
        div.innerHTML=`
          <div class="customer-header">
            <strong>${c.name}</strong>
            <div>ID: <span>${c.id}</span> <button class="small" onclick="copyId('${c.id}')">Copier</button></div>
            <div>Total: <strong>${c.total||0}</strong></div>
          </div>
          <div class="action-row-top">
            <input id="amount-${i}" class="amount-input" type="number" placeholder="Montant">
            <button onclick="addTransaction(${i},'add')">Ajouter</button>
            <button onclick="addTransaction(${i},'sub')">Soustraire</button>
          </div>
          <div class="action-row-bottom">
            <button onclick="deleteCustomer(${i})">Supprimer</button>
            <button onclick="toggleHistory(${i})">Historique</button>
          </div>
          <div id="history-${i}" class="history">
            ${c.history.map(h=>`<div>${h.date}: <strong>${h.value>0?'+':''}${h.value}</strong></div>`).join('')||'Aucun historique'}
          </div>`;
        list.appendChild(div);
        total+=c.total||0;
      });
      totalSummary.textContent=`Total clients : ${total} DA`;
    }

    renderCustomers();
  </script>
</body>
</html>
